SecurityAlert
| where TimeGenerated > ago(14d)
| where AlertName contains "malware"
| where not (
    AlertName has "Email reported by user as malware or phish"
    or AlertName has "Winring0"
    or AlertName has "CustomCertEnterpriseBlock"
    or AlertName has "EICAR_Test_File"
    or AlertName has "Malware detected in outbound email"
    or AlertName has "Malware was detected in an eml mail message file"
    or AlertName has "Malware was detected in a pst outlook data file"
    or AlertName has "Malware was detected in a mbox mail archive"
    or AlertName has "Malware was detected in a mbox mail archive during a scheduled scan"
    or AlertName has "'CVE-2017-11882' malware was prevented on an IIS Web server"
)
| mv-expand Entity = parse_json(Entities)
| where tostring(Entity.Type) =~ "host"
| extend DeviceId = tostring(Entity.MdatpDeviceId)
| where isnotempty(DeviceId)
| project TimeGenerated, DeviceId, AlertName, Description, Entities
| summarize AlertTime = min(TimeGenerated) by DeviceId
